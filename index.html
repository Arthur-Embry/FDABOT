<!DOCTYPE html>
<html lang="en" class="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FDA Approval Chatbot</title>
  <link rel="icon" type="image/png" href=https://3efzdwq8ie.ufs.sh/f/20eZA3KF6RiYKEKtRElJmx9UthcObSAC3EV70TIedz1nBMko">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <!-- Add marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            outfit: ['Outfit', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          keyframes: {
            bounce: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' }
            },
            fadeIn: {
              from: { opacity: '0' },
              to: { opacity: '1' }
            }
          },
          animation: {
            bounce: 'bounce 1s infinite',
            fadeIn: 'fadeIn 0.3s ease'
          }
        }
      }
    }

    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
      }
    });

    // Configure marked for secure rendering
    marked.setOptions({
      sanitize: true
    });
  </script>
  <!-- Matomo -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//analytics-fda.up.railway.app/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

</head>

<body
  class="font-outfit bg-gray-50 dark:bg-slate-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col antialiased">
  <header
    class="bg-white dark:bg-slate-800 shadow-sm border-b border-gray-200 dark:border-slate-700 py-3 px-4 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="https://3efzdwq8ie.ufs.sh/f/20eZA3KF6RiYKEKtRElJmx9UthcObSAC3EV70TIedz1nBMko" alt="Logo"
          class="h-16 w-16">
        <h1 class="text-xl font-semibold tracking-tight">FDA Export Compliance Assistant</h1>
      </div>
      <div class="flex items-center space-x-4">
        <!-- Mobile menu toggle -->
        <button id="mobile-menu-button"
          class="md:hidden p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
          <i class="fa-solid fa-bars"></i>
        </button>

        <button onclick="toggleDarkMode()"
          class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
          <i class="fa-solid fa-moon dark:hidden"></i>
          <i class="fa-solid fa-sun hidden dark:block"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="flex-1 flex flex-col md:flex-row">
    <!-- Sidebar for chat history -->
    <aside id="sidebar"
      class="hidden md:block w-64 bg-white dark:bg-slate-800 border-r border-gray-200 dark:border-slate-700 overflow-y-auto">
      <div class="p-4 border-b border-gray-200 dark:border-slate-700">
        <button id="new-chat-button"
          class="w-full flex items-center justify-center space-x-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg py-2 px-4 transition-colors">
          <i class="fa-solid fa-plus"></i>
          <span>New Chat</span>
        </button>
      </div>
      <div class="py-2">
        <h2 class="px-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Recent
          Chats</h2>
        <ul id="chat-history" class="space-y-1">
          <!-- Chat history will be populated here -->
        </ul>
      </div>
    </aside>

    <main class="flex-1 flex flex-col max-h-[calc(100vh-64px)] relative">
      <!-- Mobile sidebar overlay -->
      <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"
        onclick="toggleMobileSidebar()"></div>

      <div id="chat-container" class="flex-1 p-4 space-y-6 overflow-y-auto">
        <!-- System welcome message -->
        <div class="flex items-start space-x-3 animate-fadeIn">
          <div
            class="flex-shrink-0 h-9 w-9 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-700 dark:text-primary-300">
            <i class="fa-solid fa-robot"></i>
          </div>
          <div
            class="flex-1 bg-white dark:bg-slate-800 rounded-lg px-4 py-3 shadow-sm border border-gray-100 dark:border-slate-700">
            <div class="prose dark:prose-invert prose-sm sm:prose-base">
              <p>Welcome to the FDA Export Compliance Assistant!</p>
              <p>I can help with questions about the FDA Food Traceability Final Rule and export compliance
                requirements. You can also upload documents for analysis.</p>
              <p>How can I assist you today?</p>
            </div>
          </div>
        </div>

        <!-- Quick suggestions -->
        <div class="flex flex-wrap gap-2 justify-center my-2">
          <button
            class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            What foods are on the Food Traceability List?
          </button>
          <button
            class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            Compliance deadlines
          </button>
          <button
            class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            Export-only requirements
          </button>
        </div>
      </div>

      <!-- Loading indicator -->
      <div id="loading-indicator" class="hidden">
        <div class="flex justify-center py-4">
          <div class="flex space-x-1">
            <div class="h-2 w-2 bg-primary-500 dark:bg-primary-400 rounded-full animate-bounce delay-75"></div>
            <div class="h-2 w-2 bg-primary-500 dark:bg-primary-400 rounded-full animate-bounce delay-150"></div>
            <div class="h-2 w-2 bg-primary-500 dark:bg-primary-400 rounded-full animate-bounce delay-300"></div>
          </div>
        </div>
      </div>

      <!-- Input area -->
      <div class="border-t border-gray-200 dark:border-slate-700 p-4 bg-white dark:bg-slate-800">
        <form id="chat-form" class="flex flex-col space-y-3">
          <div id="file-preview" class="hidden">
            <div
              class="p-3 bg-gray-50 dark:bg-slate-700 rounded-lg border border-gray-200 dark:border-slate-600 flex items-center mb-2">
              <i class="fa-solid fa-file text-primary-500 text-xl mr-3"></i>
              <div class="flex-1 overflow-hidden">
                <div class="font-medium truncate" id="file-name">document.pdf</div>
                <div class="text-xs text-gray-500 dark:text-gray-400" id="file-size">2.4 MB</div>
              </div>
              <button type="button" id="remove-file"
                class="ml-2 p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>

          <div class="relative">
            <textarea id="message-input" placeholder="Type your message here..."
              class="w-full rounded-lg border border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-800 p-3 pr-20 resize-none focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-400 min-h-[80px] max-h-[200px]"
              rows="3"></textarea>

            <div class="absolute bottom-3 right-3 flex space-x-2">
              <button type="button" id="file-button"
                class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                <i class="fa-solid fa-paperclip"></i>
              </button>
              <input id="file-upload" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.json" />
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" id="send-button"
              class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center shadow-sm">
              <span>Send</span>
              <i class="fa-solid fa-paper-plane ml-2"></i>
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // DOM elements
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatContainer = document.getElementById('chat-container');
    const fileUpload = document.getElementById('file-upload');
    const filePreview = document.getElementById('file-preview');
    const fileButton = document.getElementById('file-button');
    const removeFileButton = document.getElementById('remove-file');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const loadingIndicator = document.getElementById('loading-indicator');
    const sidebarElement = document.getElementById('sidebar');
    const chatHistoryList = document.getElementById('chat-history');
    const newChatButton = document.getElementById('new-chat-button');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const sidebarOverlay = document.getElementById('sidebar-overlay');

    let attachedFile = null;
    let currentChatId = generateChatId();
    let chatHistory = loadChatHistory();
    let messageHistory = [
      {
        role: "system",
        content: `You are the FDA Export Compliance Assistant, a specialized AI chatbot designed to help exporters understand the FDA Food Traceability Final Rule. 
                  
Provide clear, accurate guidance on regulatory requirements for food exports, focusing on:
- Applicability to exports-only products
- Food Traceability List items and requirements
- Key Data Elements (KDEs) and Critical Tracking Events (CTEs)
- Recordkeeping requirements and formats
- Supply chain responsibilities
- Compliance timelines
- Enforcement actions
- Integration with existing systems
- Data sharing and confidentiality concerns
- Impact on international trade

Use plain language, avoid jargon, and provide practical, actionable information. When uncertain, acknowledge limitations and suggest official resources for further guidance.`
      }
    ];

    // Initialize the chat interface
    initializeChat();

    // Generate a unique chat ID
    function generateChatId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    // Load chat history from localStorage
    function loadChatHistory() {
      try {
        const savedHistory = localStorage.getItem('chatHistory');
        return savedHistory ? JSON.parse(savedHistory) : [];
      } catch (error) {
        console.error("Error loading chat history:", error);
        return [];
      }
    }

    // Save chat history to localStorage
    function saveChatHistory(history) {
      try {
        localStorage.setItem('chatHistory', JSON.stringify(history));
      } catch (error) {
        console.error("Error saving chat history:", error);
      }
    }

    // Initialize the chat interface
    function initializeChat() {
      updateChatHistorySidebar();

      // If there are no chats, create a new one
      if (chatHistory.length === 0) {
        createNewChat();
      } else {
        // Load the most recent chat
        loadChat(chatHistory[0].id);
      }
    }

    // Create a new chat
    function createNewChat() {
      const id = generateChatId();
      const timestamp = new Date();

      const newChat = {
        id: id,
        title: "New Conversation",
        timestamp: timestamp,
        messages: [{
          role: "assistant",
          content: "Welcome to the FDA Export Compliance Assistant! I can help with questions about the FDA Food Traceability Final Rule and export compliance requirements. You can also upload documents for analysis. How can I assist you today?"
        }]
      };

      // Add to chat history
      chatHistory.unshift(newChat);
      saveChatHistory(chatHistory);

      // Update UI
      currentChatId = id;
      updateChatHistorySidebar();
      loadChat(id);
    }

    // Update the sidebar with chat history
    function updateChatHistorySidebar() {
      chatHistoryList.innerHTML = '';

      chatHistory.forEach((chat, index) => {
        const li = document.createElement('li');

        // Format timestamp
        const date = new Date(chat.timestamp);
        const formattedDate = date.toLocaleDateString(undefined, {
          month: 'short',
          day: 'numeric'
        });

        const isActive = chat.id === currentChatId;

        li.innerHTML = `
          <button data-chat-id="${chat.id}" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors flex items-center rounded-lg mx-1 ${isActive ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300' : ''}">
            <i class="fa-solid fa-comments mr-3 ${isActive ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400 dark:text-gray-500'}"></i>
            <div class="overflow-hidden">
              <div class="font-medium truncate">${chat.title}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400 truncate">${formattedDate}</div>
            </div>
            ${index > 0 ? `
            <button class="delete-chat-btn ml-auto p-1 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400" data-chat-id="${chat.id}">
              <i class="fa-solid fa-trash-alt"></i>
            </button>` : ''}
          </button>
        `;

        chatHistoryList.appendChild(li);

        // Add event listener to chat button
        li.querySelector('button[data-chat-id]').addEventListener('click', (e) => {
          const chatId = e.currentTarget.dataset.chatId;
          loadChat(chatId);
        });

        // Add event listener to delete button if it exists
        const deleteBtn = li.querySelector('.delete-chat-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chatId = e.currentTarget.dataset.chatId;
            deleteChat(chatId);
          });
        }
      });
    }

    // Load a specific chat
    function loadChat(chatId) {
      const chat = chatHistory.find(c => c.id === chatId);
      if (!chat) return;

      // Update current chat ID
      currentChatId = chatId;

      // Clear chat container
      chatContainer.innerHTML = '';

      // Reset message history
      messageHistory = [
        {
          role: "system",
          content: `You are the FDA Export Compliance Assistant, a specialized AI chatbot designed to help exporters understand the FDA Food Traceability Final Rule. 
                    
  Provide clear, accurate guidance on regulatory requirements for food exports, focusing on:
  - Applicability to exports-only products
  - Food Traceability List items and requirements
  - Key Data Elements (KDEs) and Critical Tracking Events (CTEs)
  - Recordkeeping requirements and formats
  - Supply chain responsibilities
  - Compliance timelines
  - Enforcement actions
  - Integration with existing systems
  - Data sharing and confidentiality concerns
  - Impact on international trade
  
  Use plain language, avoid jargon, and provide practical, actionable information. When uncertain, acknowledge limitations and suggest official resources for further guidance.`
        }
      ];

      // Add messages to chat container and message history
      chat.messages.forEach(msg => {
        if (msg.role !== 'system') {
          addMessageToChat(msg.role, msg.content, msg.attachmentInfo);

          // Only add non-welcome messages to the message history
          if (!(msg.role === 'assistant' && msg.content.includes("Welcome to the FDA Export Compliance Assistant"))) {
            messageHistory.push({
              role: msg.role,
              content: msg.content
            });
          }
        }
      });

      // Add quick suggestion buttons if it's a new chat
      if (chat.messages.length === 1 && chat.messages[0].role === 'assistant') {
        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'flex flex-wrap gap-2 justify-center my-2';
        suggestionsDiv.innerHTML = `
          <button class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            What foods are on the Food Traceability List?
          </button>
          <button class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            Compliance deadlines
          </button>
          <button class="suggestion-btn bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-full px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
            Export-only requirements
          </button>
        `;
        chatContainer.appendChild(suggestionsDiv);

        // Add event listeners to suggestion buttons
        suggestionsDiv.querySelectorAll('.suggestion-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            messageInput.value = btn.textContent.trim();
            messageInput.dispatchEvent(new Event('input'));
          });
        });
      }

      // Update sidebar
      updateChatHistorySidebar();

      // Scroll to bottom
      chatContainer.scrollTop = chatContainer.scrollHeight;

      // Close mobile sidebar if open
      if (window.innerWidth < 768) {
        toggleMobileSidebar(false);
      }
    }

    // Update chat title based on the first user message
    function updateChatTitle(chatId, userMessage) {
      const chat = chatHistory.find(c => c.id === chatId);
      if (!chat) return;

      // Only update if it's still the default title
      if (chat.title === "New Conversation") {
        // Use the first 30 chars of user message as title
        chat.title = userMessage.substring(0, 30);
        if (userMessage.length > 30) chat.title += "...";

        saveChatHistory(chatHistory);
        updateChatHistorySidebar();
      }
    }

    // Delete a chat
    function deleteChat(chatId) {
      // Filter out the chat to delete
      chatHistory = chatHistory.filter(c => c.id !== chatId);
      saveChatHistory(chatHistory);

      // If we deleted the current chat, load another one or create a new one
      if (chatId === currentChatId) {
        if (chatHistory.length > 0) {
          loadChat(chatHistory[0].id);
        } else {
          createNewChat();
        }
      } else {
        updateChatHistorySidebar();
      }
    }

    // Toggle mobile sidebar
    function toggleMobileSidebar(show) {
      if (show === undefined) {
        show = sidebarElement.classList.contains('hidden') ||
          !sidebarElement.classList.contains('fixed');
      }

      if (show) {
        sidebarElement.classList.remove('hidden');
        sidebarElement.classList.add('fixed', 'top-[64px]', 'left-0', 'bottom-0', 'z-30');
        sidebarOverlay.classList.remove('hidden');
      } else {
        sidebarElement.classList.remove('fixed', 'top-[64px]', 'left-0', 'bottom-0', 'z-30');
        if (window.innerWidth < 768) {
          sidebarElement.classList.add('hidden');
        }
        sidebarOverlay.classList.add('hidden');
      }
    }

    // Function to format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // File button click handler
    fileButton.addEventListener('click', () => {
      fileUpload.click();
    });

    // Handle file selection
    fileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        attachedFile = file;
        filePreview.classList.remove('hidden');
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);

        // Show appropriate icon based on file type
        const fileIcon = filePreview.querySelector('i');
        const fileType = file.type.split('/')[0];
        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (fileType === 'application' && fileExtension === 'pdf') {
          fileIcon.className = 'fa-solid fa-file-pdf text-red-500 text-xl mr-3';
        } else if (fileType === 'application' && ['doc', 'docx'].includes(fileExtension)) {
          fileIcon.className = 'fa-solid fa-file-word text-blue-600 text-xl mr-3';
        } else if (fileType === 'application' && ['xls', 'xlsx'].includes(fileExtension)) {
          fileIcon.className = 'fa-solid fa-file-excel text-green-600 text-xl mr-3';
        } else if (fileExtension === 'csv') {
          fileIcon.className = 'fa-solid fa-file-csv text-green-600 text-xl mr-3';
        } else if (fileExtension === 'json') {
          fileIcon.className = 'fa-solid fa-file-code text-yellow-500 text-xl mr-3';
        } else if (fileExtension === 'txt') {
          fileIcon.className = 'fa-solid fa-file-lines text-gray-500 text-xl mr-3';
        } else {
          fileIcon.className = 'fa-solid fa-file text-gray-500 text-xl mr-3';
        }
      }
    });

    // Remove attached file
    removeFileButton.addEventListener('click', () => {
      attachedFile = null;
      filePreview.classList.add('hidden');
      fileUpload.value = '';
    });

    // Add message to chat
    function addMessageToChat(role, content, attachmentInfo = null) {
      const isUser = role === 'user';
      const messageDiv = document.createElement('div');

      messageDiv.className = `flex items-start ${isUser ? 'justify-end space-x-reverse space-x-3' : 'space-x-3'} animate-fadeIn`;

      const avatarHTML = isUser ?
        `<div class="flex-shrink-0 h-9 w-9 rounded-full bg-gray-200 dark:bg-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-user text-gray-500 dark:text-gray-400"></i>
        </div>` :
        `<div class="flex-shrink-0 h-9 w-9 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-700 dark:text-primary-300">
          <i class="fa-solid fa-robot"></i>
        </div>`;

      const contentFormatted = isUser ? content : marked.parse(content);

      const message = `
        ${!isUser ? avatarHTML : ''}
        <div class="flex-1 ${isUser ? 'bg-primary-600 text-white' : 'bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700'} rounded-lg px-4 py-3 shadow-sm ${isUser ? 'ml-12' : 'mr-12'}">
          <div class="${isUser ? '' : 'prose dark:prose-invert prose-sm sm:prose-base'}">
            ${contentFormatted}
          </div>
          ${attachmentInfo ? `
          <div class="mt-3 p-3 ${isUser ? 'bg-primary-700/50' : 'bg-gray-50 dark:bg-slate-700'} rounded-lg flex items-center">
            <i class="fa-solid fa-file ${isUser ? '' : 'text-primary-500'} mr-3"></i>
            <div class="flex-1">
              <div class="font-medium">${attachmentInfo.name}</div>
              <div class="text-xs ${isUser ? 'text-primary-200' : 'text-gray-500 dark:text-gray-400'}">${attachmentInfo.size}</div>
            </div>
          </div>` : ''}
        </div>
        ${isUser ? avatarHTML : ''}
      `;

      messageDiv.innerHTML = message;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      // Add event listeners to code blocks for markdown content
      if (!isUser) {
        messageDiv.querySelectorAll('pre code').forEach(block => {
          block.classList.add('bg-gray-100', 'dark:bg-slate-700', 'p-3', 'rounded', 'overflow-x-auto', 'block');
        });

        messageDiv.querySelectorAll('a').forEach(link => {
          link.classList.add('text-primary-600', 'dark:text-primary-400', 'hover:underline');
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
      }
    }

    // Update chat in history with new message
    function updateChatWithMessage(role, content, attachmentInfo = null) {
      const chat = chatHistory.find(c => c.id === currentChatId);
      if (!chat) return;

      chat.messages.push({
        role: role,
        content: content,
        attachmentInfo: attachmentInfo
      });

      chat.timestamp = new Date();

      // If this is the first user message, update the chat title
      if (role === 'user' && chat.messages.filter(m => m.role === 'user').length === 1) {
        updateChatTitle(currentChatId, content);
      }

      // Move this chat to the top of the list
      const chatIndex = chatHistory.findIndex(c => c.id === currentChatId);
      if (chatIndex > 0) {
        const currentChat = chatHistory.splice(chatIndex, 1)[0];
        chatHistory.unshift(currentChat);
      }

      saveChatHistory(chatHistory);
      updateChatHistorySidebar();
    }

    // Process file content
    async function processFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // For now, just return the filename and "parsed file" text
            // This would be replaced with actual file processing logic
            resolve(`[filename: "${file.name}"] parsed file`);
          } catch (error) {
            reject(error);
          }
        };
        reader.onerror = function (e) {
          reject(new Error("Error reading file"));
        };

        // Read the file based on type
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (fileExtension === 'json') {
          reader.readAsText(file);
        } else if (['txt', 'csv'].includes(fileExtension)) {
          reader.readAsText(file);
        } else {
          // For other file types like PDFs, in a real implementation
          // you might use specialized libraries or APIs
          reader.readAsDataURL(file);
        }
      });
    }

    // Call Groq API
    async function callGroqAPI(messages) {
      try {
        const apiKey = "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"; // In production, this should be secured

        // In a real app, you'd make this request from your backend
        // This is a client-side implementation for demo purposes
        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            messages: messages,
            model: "llama-3.3-70b-versatile",
            temperature: 0.7,
            max_completion_tokens: 1024,
            top_p: 1
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error("Error calling Groq API:", error);
        return "I'm sorry, I encountered an error processing your request. Please try again later.";
      }
    }

    // Simulate streaming for demo
    function simulateStreaming(element, text) {
      return new Promise((resolve) => {
        const words = text.split(' ');
        let currentIndex = 0;

        const interval = setInterval(() => {
          if (currentIndex < words.length) {
            element.innerHTML += words[currentIndex] + ' ';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            currentIndex++;
          } else {
            clearInterval(interval);
            resolve();
          }
        }, 30);
      });
    }

    // Handle form submission
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = messageInput.value.trim();

      if (!message && !attachedFile) return;

      // Add user message to chat
      let userContent = message;
      let attachmentInfo = null;

      if (attachedFile) {
        attachmentInfo = {
          name: attachedFile.name,
          size: formatFileSize(attachedFile.size)
        };
      }

      // Add user message to chat UI
      addMessageToChat('user', userContent, attachmentInfo);

      // Update chat history
      updateChatWithMessage('user', userContent, attachmentInfo);

      // Clear input fields
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // Process file if attached
      let fileContent = null;
      if (attachedFile) {
        try {
          fileContent = await processFile(attachedFile);

          // Add file content to user message for AI context
          userContent += fileContent ? `\n\nAttached file content: ${fileContent}` : '';
        } catch (error) {
          console.error("Error processing file:", error);
        }

        // Clear file attachment
        attachedFile = null;
        filePreview.classList.add('hidden');
        fileUpload.value = '';
      }

      // Add to message history for API
      messageHistory.push({
        role: "user",
        content: userContent
      });

      // Show loading indicator
      loadingIndicator.classList.remove('hidden');

      try {
        // Create response container first
        const responseDiv = document.createElement('div');
        responseDiv.className = 'flex items-start space-x-3 animate-fadeIn';

        responseDiv.innerHTML = `
          <div class="flex-shrink-0 h-9 w-9 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-700 dark:text-primary-300">
            <i class="fa-solid fa-robot"></i>
          </div>
          <div class="flex-1 bg-white dark:bg-slate-800 rounded-lg px-4 py-3 shadow-sm border border-gray-100 dark:border-slate-700 mr-12">
            <div class="prose dark:prose-invert prose-sm sm:prose-base"></div>
          </div>
        `;

        chatContainer.appendChild(responseDiv);
        const contentContainer = responseDiv.querySelector('.prose');

        // Call API
        const response = await callGroqAPI(messageHistory);

        // Hide loading indicator
        loadingIndicator.classList.add('hidden');

        // Convert markdown to HTML
        const formattedResponse = marked.parse(response);

        // Add response to chat UI
        contentContainer.innerHTML = formattedResponse;

        // Add response to chat history
        updateChatWithMessage('assistant', response);

        // Add to message history for context in future requests
        messageHistory.push({
          role: "assistant",
          content: response
        });

        // Add event listeners to code blocks for better styling
        responseDiv.querySelectorAll('pre code').forEach(block => {
          block.classList.add('bg-gray-100', 'dark:bg-slate-700', 'p-3', 'rounded', 'overflow-x-auto', 'block');
        });

        responseDiv.querySelectorAll('a').forEach(link => {
          link.classList.add('text-primary-600', 'dark:text-primary-400', 'hover:underline');
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        });
      } catch (error) {
        console.error("Error:", error);
        loadingIndicator.classList.add('hidden');

        // Add error message to chat
        const errorMessage = "I'm sorry, I encountered an error processing your request. Please try again later.";
        addMessageToChat('assistant', errorMessage);
        updateChatWithMessage('assistant', errorMessage);
      }

      // Scroll to bottom
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function () {
      this.style.height = 'auto';
      const maxHeight = 200;
      this.style.height = (this.scrollHeight > maxHeight ? maxHeight : this.scrollHeight) + 'px';
    });
    // Add event listener for Enter key submission
    messageInput.addEventListener('keydown', (e) => {
      // Submit on Enter without Shift key
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent new line
        document.getElementById('send-button').click(); // Trigger send button click
      }
    });
    // Handle mobile menu toggle
    mobileMenuButton.addEventListener('click', () => {
      toggleMobileSidebar();
    });

    // New chat button handler
    newChatButton.addEventListener('click', () => {
      createNewChat();
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        sidebarElement.classList.remove('hidden', 'fixed', 'top-[64px]', 'left-0', 'bottom-0', 'z-30');
        sidebarOverlay.classList.add('hidden');
      } else if (!sidebarElement.classList.contains('fixed')) {
        sidebarElement.classList.add('hidden');
      }
    });

    // Handle suggestion buttons
    document.querySelectorAll('.suggestion-btn').forEach(button => {
      button.addEventListener('click', () => {
        messageInput.value = button.textContent.trim();
        messageInput.dispatchEvent(new Event('input'));
      });
    });

    // Handle keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+Enter or Cmd+Enter to submit
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (document.activeElement === messageInput) {
          document.getElementById('send-button').click();
        }
      }

      // Escape to close mobile sidebar
      if (e.key === 'Escape' && window.innerWidth < 768) {
        if (!sidebarElement.classList.contains('hidden')) {
          toggleMobileSidebar(false);
        }
      }
    });



  </script>
</body>

</html>